import{c as tt,V as L,v as nt,r as P,w as Ce,x as it,y as ke,z as ve,J as ie,A as Ge,t as st,u as Ue,j as e,B as w,b as je,s as ye,D as ge,E as Ae,F as lt,G as De,d as ct,R as dt,H as ut,I as at,K as He,q as pt,M as _e,N as mt,X as ht}from"./index-e1be7c10.js";import{u as gt}from"./useWallet-45da9ffa.js";import{a as xe,A as Ke}from"./contracts-3445139a.js";import{E as be,P as _,T as xt,a as te}from"./vote-helpers-5e69d632.js";import{f as Qe}from"./api-utils-216de986.js";import{U as le}from"./UnifiedProposalCard-a5b0458b.js";import{o as ft,s as ce,e as vt,u as yt,t as jt}from"./types-4adccaac.js";import{D as bt,a as fe,b as Q,c as J,d as X,e as de,I as $e}from"./label-89400795.js";import{F as Te,a as se,b as ae,c as re,d as ue,e as pe,f as oe}from"./form-636354d0.js";import{S as Ie,a as Le,b as Re,c as Be,d as K}from"./select-533c5ae9.js";import{T as wt}from"./textarea-905500f1.js";import{u as rt,P as Je}from"./PageContainer-8e534529.js";import{A as Y,a as W,b as z}from"./alert-e582690e.js";import{ADDRESSES as Xe}from"./contracts-7ce1c1bb.js";import{P as Nt}from"./progress-e347a56a.js";import{C as we,a as Ne,b as Me,c as Pe,e as Pt,d as Ct}from"./card-3ad46239.js";import{S as kt,a as Ee,C as At}from"./separator-aa7542c2.js";import{C as Ze}from"./circle-alert-0fd31702.js";import{L as et}from"./loader-circle-4ab48cad.js";import{C as ne}from"./index-c43f57c1.js";import{A as Dt}from"./activity-6a1b6971.js";import{C as Ve,P as Se}from"./plus-a107ef71.js";import{T as Tt,a as Et,b as me,c as he}from"./tabs-02bc0b10.js";import{R as Vt,T as St}from"./triangle-alert-3b454864.js";import{P as Oe}from"./page-header-ce70d00b.js";import{S as Z}from"./skeleton-77e1d972.js";import{C as Ot}from"./countdown-timer-3cae2c82.js";import{C as Ft}from"./circle-check-big-e37d016f.js";import{I as $t}from"./info-fd4f4609.js";import"./provider-infura-b77f0efa.js";import"./useTokenInfo-41555799.js";import"./clock-8783fbb7.js";import"./chevron-up-a937d1d5.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=tt("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=tt("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);function Rt(){function t(f){const u=f.id||`toast-${Date.now()}`;return f.variant==="destructive"?L.error(f.description,{id:u,duration:f.duration||5e3,position:"top-right"}):L(f.description,{id:u,duration:f.duration||3e3,position:"top-right"})}function l(f){L.dismiss(f)}function i(){L.dismiss()}return{toast:t,dismiss:l,dismissAll:i}}const Bt={ZeroAddress:{message:"Invalid address provided",category:"user_error",retryable:!0,suggestedAction:"Please check the token address and try again."},InvalidAmount:{message:"Invalid amount specified",category:"user_error",retryable:!0,suggestedAction:"Amount must be greater than zero."},CallerNotAdmin:{message:"Admin permission required",category:"permission",retryable:!1,suggestedAction:"This action requires admin privileges."},CallerNotOwner:{message:"Owner permission required",category:"permission",retryable:!1,suggestedAction:"This action requires owner privileges."},NotAuthorized:{message:"Not authorized",category:"permission",retryable:!1,suggestedAction:"You do not have permission to perform this action."},ProposalNotFound:{message:"Proposal not found",category:"data",retryable:!1,suggestedAction:"This proposal may have been removed or never existed."},ProposalAlreadyExecuted:{message:"Proposal already executed",category:"data",retryable:!1,suggestedAction:"This proposal has already been processed."},QuorumNotReached:{message:"Quorum not reached",category:"data",retryable:!1,suggestedAction:"The proposal needs more votes before it can be executed."},MajorityNotReached:{message:"Majority not reached",category:"data",retryable:!1,suggestedAction:"The proposal did not receive enough yes votes to pass."},TokenNotWhitelisted:{message:"Token not supported",category:"data",retryable:!1,suggestedAction:"This token is not supported by the protocol."},VotingPeriodEnded:{message:"Voting period ended",category:"data",retryable:!1,suggestedAction:"The voting period for this proposal has ended."},VotingPeriodNotEnded:{message:"Voting still in progress",category:"data",retryable:!1,suggestedAction:"Wait until the voting period ends before executing the proposal."},TimelockPeriodNotElapsed:{message:"Timelock period not elapsed",category:"data",retryable:!0,suggestedAction:"Wait until the timelock period ends before executing the proposal."},"user rejected":{message:"Transaction rejected",category:"user_error",retryable:!0,suggestedAction:"You rejected the transaction request in your wallet."},"insufficient funds":{message:"Insufficient funds",category:"user_error",retryable:!0,suggestedAction:"Add more funds to your wallet to cover transaction costs."},"gas required exceeds allowance":{message:"Gas limit too low",category:"transaction",retryable:!0,suggestedAction:"Try increasing the gas limit in your wallet settings."},"nonce too high":{message:"Transaction sequence error",category:"transaction",retryable:!0,suggestedAction:"Refresh your browser and try again."},"network disconnected":{message:"Network disconnected",category:"network",retryable:!0,suggestedAction:"Check your internet connection and try again."},"execution reverted":{message:"Transaction reverted",category:"transaction",retryable:!0,suggestedAction:"The transaction was reverted by the blockchain. Check your inputs and try again."}};function Mt(t){var $;const l=(t==null?void 0:t.message)||(t==null?void 0:t.reason)||(t==null?void 0:t.toString())||"",i=(($=t==null?void 0:t.code)==null?void 0:$.toString())||"";if(console.debug("Contract error:",{message:l,code:i,error:t}),i==="ACTION_REJECTED")return{message:"Transaction rejected",details:l,category:"user_error",retryable:!0,suggestedAction:"You rejected the transaction in your wallet."};for(const[F,V]of Object.entries(Bt))if(l.includes(F))return{message:V.message,details:l,category:V.category,retryable:V.retryable,suggestedAction:V.suggestedAction};if(l.includes("could not detect network")||l.includes("network changed")||l.includes("disconnected")||l.includes("connection error"))return{message:"Network connection issue",details:l,category:"network",retryable:!0,suggestedAction:"Check your internet connection and wallet connection status."};const f=l.replace(/0x[a-fA-F0-9]{8,}/g,"[hex]");return{message:"Transaction failed",details:f.length>150?`${f.substring(0,150)}...`:f,category:"unknown",retryable:!0,suggestedAction:"Please try again or contact support if the issue persists."}}function Ut(t){const l=Mt(t);return l.suggestedAction?`${l.message}: ${l.suggestedAction}`:l.message}const Fe={Investment:0,Divestment:1,ParameterChange:2,Other:3};function ot(t,l="invest"){if(t==null||t==="")return l;if(typeof t=="string"){if(!isNaN(Number(t)))return ot(Number(t));const f=t.toLowerCase().trim();return f==="invest"||f==="investment"?"invest":f==="divest"||f==="divestment"?"divest":(console.debug(`Unrecognized string proposal type: "${t}", defaulting to 'invest'`),"invest")}if(t==null)return"invest";const i=Number(t);return isNaN(i)||i===0?"invest":i===1?"divest":"invest"}const qt=t=>{switch(t){case"invest":return Fe.Investment;case"divest":return Fe.Divestment;default:return console.warn(`Unmapped UI type: ${t}, defaulting to Investment (0)`),Fe.Investment}},qe=()=>{const{signer:t,isConnected:l}=gt(),{provider:i,signer:f}=nt(),{toast:u}=Rt(),[$,F]=P.useState(!1),{data:V}=Ce({queryKey:["protocol-metrics"],queryFn:async()=>{try{return await Qe("/api/protocol/metrics")}catch(n){return console.error("Error fetching protocol metrics:",n),null}},enabled:!0,staleTime:60*1e3}),{data:H,isLoading:I,error:v}=Ce({queryKey:["protocol-dao-proposals"],queryFn:async()=>{try{return await Qe("/api/protocol/proposals")}catch(n){return console.error("Error fetching protocol proposals:",n),[]}},enabled:!0,staleTime:60*1e3}),{data:B,isLoading:x,error:E,refetch:R}=Ce({queryKey:["asset-dao-proposals"],queryFn:async()=>{if(!i)return[];try{let n;if(i instanceof ie)n=i;else if(i instanceof Ge)try{n=await i.getSigner().catch(()=>new ie("https://sepolia.infura.io/v3/"))}catch{n=new ie("https://sepolia.infura.io/v3/")}else n=new ie("https://sepolia.infura.io/v3/");const g=t||n;return(await be.getAllProposals(g)).map(s=>{var b;const c=j=>["Pending","Active","Succeeded","Defeated","Executed","Canceled","Expired"][j]||"Unknown",ee=j=>{switch(j){case _.Active:case _.Pending:return"active";case _.Succeeded:case _.Queued:return"passed";case _.Defeated:case _.Expired:return"failed";case _.Executed:return"executed";default:return"active"}},O=j=>ot(j),r=!!s.canceled,p=j=>{try{return typeof j=="string"&&j.includes(".")&&(j=j.split(".")[0]),ve(j)}catch(q){return console.warn("Error formatting ether value:",q,j),"0"}},m=G.find(j=>j.symbol===s.token);return{id:s.id,title:((b=s.description)==null?void 0:b.split(`
`)[0])||`Proposal ${s.id}`,description:s.description||"",proposer:s.proposer,createdAt:s.createdAt instanceof Date?s.createdAt.getTime():0,endTime:s.votingEnds instanceof Date?s.votingEnds.getTime():0,forVotes:parseFloat(p(s.forVotes)),againstVotes:parseFloat(p(s.againstVotes)),executed:s.state===_.Executed,canceled:r,status:ee(s.state),state:c(s.state),type:O(s.type),amount:parseFloat(p(s.amount)),token:s.token,endsIn:s.votingEnds instanceof Date?st(s.votingEnds.getTime()):"",contractAddress:m==null?void 0:m.address}})}catch(n){return console.error("Error fetching proposals:",n),[]}},enabled:!!i,staleTime:60*1e3}),S=it();P.useCallback(()=>{if(!i)return;const n=xe("AssetDAO",i),g=()=>{S.invalidateQueries({queryKey:["asset-dao-proposals"]})};return n.on("ProposalCreated",g),()=>{n.off("ProposalCreated",g)}},[i,S]);const G=[{symbol:"DLOOP",address:"0x05B366778566e93abfB8e4A9B794e4ad006446b4"},{symbol:"USDC",address:"0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238"},{symbol:"WBTC",address:"0xCA063A2AB07491eE991dCecb456D1265f842b568"}],k=async n=>{if(!t||!l){u({title:"Not Connected",description:"Please connect your wallet first.",variant:"destructive"});return}F(!0);try{const g=qt(n.type);if(console.log("Creating proposal with parameters:",n),console.log("Mapped UI type",n.type,"to contract type",g),!(await fetch("/api/proposals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...n,contractProposalType:g})})).ok)throw new Error("Failed to create proposal in database");return u({title:"Proposal Recorded",description:"Your proposal has been recorded in our database."}),S.invalidateQueries({queryKey:["asset-dao-proposals"]}),!0}catch(g){return console.error("Error creating proposal in database:",g),u({title:"Proposal Recording Failed",description:g.message||"There was an error recording your proposal. Please try again.",variant:"destructive"}),!1}finally{F(!1)}},d=ke({mutationFn:async({proposalId:n,support:g})=>{if(!t||!l)throw new Error("Please connect your wallet first.");try{const h=await be.voteOnProposal(t,n,g);return{proposalId:n,success:!0,receipt:h}}catch(h){const o=Ut(h);throw new Error(o)}},onSuccess:()=>(u({title:"Vote Cast",description:"Your vote has been cast successfully."}),S.invalidateQueries({queryKey:["asset-dao-proposals"]}),!0),onError:n=>{u({title:"Vote Failed",description:n.message||"There was an error casting your vote. Please try again.",variant:"destructive"})}}),a=ke({mutationFn:async n=>{if(!t||!l)throw new Error("Please connect your wallet first.");return await(await xe("AssetDAO",t).executeProposal(n)).wait(),{proposalId:n,success:!0}},onSuccess:()=>(u({title:"Proposal Executed",description:"The proposal has been executed successfully."}),S.invalidateQueries({queryKey:["asset-dao-proposals"]}),!0),onError:n=>{u({title:"Execution Failed",description:n.message||"There was an error executing the proposal. Please try again.",variant:"destructive"})}}),N=ke({mutationFn:async n=>{if(!t||!l)throw new Error("Please connect your wallet first.");return await(await xe("AssetDAO",t).cancelProposal(n)).wait(),{proposalId:n,success:!0}},onSuccess:()=>(u({title:"Proposal Canceled",description:"The proposal has been canceled successfully."}),S.invalidateQueries({queryKey:["asset-dao-proposals"]}),!0),onError:n=>{u({title:"Cancellation Failed",description:n.message||"There was an error canceling the proposal. Please try again.",variant:"destructive"})}});P.useCallback(n=>{if(n.executed)return"executed";if(n.canceled)return"failed";const g=Date.now(),h=n.votingEnds.toNumber()*1e3;if(g<h)return"active";const o=parseFloat(ve(n.forVotes)),s=parseFloat(ve(n.againstVotes));return o>s?"passed":"failed"},[]);const y=async(n,g)=>{if(!t||!l)return u({title:"Not Connected",description:"Please connect your wallet first.",variant:"destructive"}),{success:!1};try{return u({title:"Vote Cast",description:"Your vote has been cast successfully on protocol proposal."}),{success:!0}}catch(h){return console.error("Error voting on protocol proposal:",h),u({title:"Vote Failed",description:h.message||"There was an error casting your vote. Please try again.",variant:"destructive"}),{success:!1}}},D=async n=>{if(!t||!l)return u({title:"Not Connected",description:"Please connect your wallet first.",variant:"destructive"}),{success:!1};try{return u({title:"Proposal Executed",description:"The protocol proposal has been executed successfully."}),{success:!0}}catch(g){return console.error("Error executing protocol proposal:",g),u({title:"Execution Failed",description:g.message||"There was an error executing the proposal. Please try again.",variant:"destructive"}),{success:!1}}},U=async(n,g)=>{if(!i||!g)return null;try{let h;if(i instanceof Ge)try{h=await i.getSigner()}catch{h=new ie("https://sepolia.infura.io/v3/")}else h=i;const o=xe("AssetDAO",h),s=await o.hasVoted(n,g);if(s)try{const c=await o.getVoterSupport(n,g);return{hasVoted:s,support:c}}catch(c){return console.error("Error getting voter support:",c),{hasVoted:s,support:!1}}return{hasVoted:!1,support:!1}}catch(h){return console.error("Error checking vote status:",h),null}};return{createProposal:k,voteOnProposal:d.mutateAsync,executeProposal:a.mutateAsync,cancelProposal:N.mutateAsync,checkUserVote:U,proposals:B,isLoading:x,isSubmitting:$,refetchProposals:R,protocolProposals:H,protocolLoading:I,protocolError:v,protocolMetrics:V,error:E||v,voteOnProtocolProposal:y,executeProtocolProposal:D}},Yt=ft({title:ce().min(5,"Title must be at least 5 characters").max(100,"Title cannot exceed 100 characters"),description:ce().min(20,"Description must be at least 20 characters").max(2e3,"Description cannot exceed 2000 characters"),type:vt(["invest","divest"]),token:ce().min(1,"Please select an asset"),amount:ce().refine(t=>{const l=parseFloat(t);return!isNaN(l)&&l>0},{message:"Amount must be a positive number"}),duration:ce().refine(t=>["3","5","7","14"].includes(t),{message:"Please select a valid duration"})});function Wt({isOpen:t,onClose:l}){console.log("EnhancedProposalModal loaded - Latest version with smart title and description generation");const{isConnected:i,address:f,signer:u}=Ue(),{createProposal:$,isSubmitting:F}=qe(),{toast:V}=rt(),[H,I]=P.useState(null),[v,B]=P.useState(null),[x,E]=P.useState("type"),[R,S]=P.useState(null),[G,k]=P.useState(null),d=[{symbol:"DLOOP",address:"0x05B366778566e93abfB8e4A9B794e4ad006446b4",supportedTypes:[]},{symbol:"USDC",address:"0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238",supportedTypes:["invest","divest"]},{symbol:"WBTC",address:"0xCA063A2AB07491eE991dCecb456D1265f842b568",supportedTypes:["invest","divest"]}];P.useEffect(()=>{console.log("Available tokens for proposals:",d)},[]);const a=yt({resolver:jt(Yt),defaultValues:{title:"",description:"",type:"invest",token:"",amount:"",duration:"3"},mode:"onChange"}),N=a.watch("type"),y=a.watch("token"),D=a.watch("amount"),U=d.filter(r=>r.supportedTypes&&r.supportedTypes.length>0&&r.supportedTypes.includes(N));P.useEffect(()=>{t&&console.log(`Available tokens for ${N} proposals:`,U.map(r=>r.symbol))},[t,N,U]),P.useEffect(()=>{if(y){let r;D&&parseFloat(D)>0?r=`${N==="invest"?"Add":"Remove"} ${D} ${y} to the DAO`:r=`${N==="invest"?"Invest in":"Divest from"} ${y}`;const p=a.getValues("title");(!p||p===`${N==="invest"?"Invest in":"Divest from"} ${y==="DLOOP"?"USDC":"DLOOP"}`||/^(Add|Remove) \d+\.?\d* (USDC|WBTC|DLOOP|PAXG) to the DAO$/.test(p))&&a.setValue("title",r,{shouldValidate:!0})}},[y,N,D]),P.useEffect(()=>{if(y&&D&&parseFloat(D)>0){const r=a.getValues("description");if(!r||/^(I propose to (invest|divest) \d+\.?\d* [A-Z]+ (into|from) the DAO treasury|This proposal seeks to (add|remove) \d+\.?\d* [A-Z]+ (to|from) our asset portfolio)/.test(r)){let m="";d.find(b=>b.symbol===y),N==="invest"?(m=`I propose to invest ${D} ${y} into the DAO treasury.

`,y==="USDC"?m+="This allocation to USDC will strengthen our stable asset reserves, providing better liquidity options for future investments and reducing portfolio volatility.":y==="WBTC"?m+="Adding WBTC exposure to our portfolio will help preserve value against inflation and provide non-correlated assets for long-term treasury growth.":y==="PAXG"?m+="Gold-backed PAXG will serve as a hedge against market uncertainty and diversify our treasury with a traditional store of value.":m+="This investment will diversify our treasury and position us for future growth opportunities."):(m=`This proposal seeks to remove ${D} ${y} from our asset portfolio.

`,y==="USDC"?m+="Reducing our USDC position will allow us to deploy capital into higher-yielding assets while maintaining sufficient reserves for operational needs.":y==="WBTC"?m+="Divesting from WBTC at this time allows us to realize gains and rebalance our portfolio in response to current market conditions.":y==="DLOOP"?m+="This strategic reduction in DLOOP holdings will help fund new initiatives while maintaining appropriate treasury diversity.":m+="This divestment will help rebalance our treasury and free up capital for other strategic opportunities."),a.setValue("description",m,{shouldValidate:!0})}}},[y,N,D,a]);const n=()=>{const r=["type","assets","details","review"];return(r.indexOf(x)+1)/r.length*100},g=()=>{a.reset(),I(null),B(null),E("type"),S(null),k(null)},h=()=>{g(),l()},o=async()=>{let r=!0;if(x==="type")await a.trigger("type")||(r=!1);else if(x==="details"){const p=await a.trigger("title"),m=await a.trigger("description");(!p||!m)&&(r=!1)}else if(x==="assets"){const p=await a.trigger("token"),m=await a.trigger("amount"),b=await a.trigger("duration");(!p||!m||!b)&&(r=!1)}if(r)if(x==="type")E("assets");else if(x==="assets")E("details");else if(x==="details")try{await c(),E("review")}catch(p){console.error("Failed to estimate gas:",p),E("review")}else x==="review"&&ee()},s=()=>{x==="assets"?E("type"):x==="details"?E("assets"):x==="review"&&E("details")},c=async()=>{if(!(!u||!y||!D))try{const r=Ke(u),p=d.find(M=>M.symbol===y);if(!p)return;let m;y==="DLOOP"||y==="ETH"?m=ge(D):y==="USDC"?m=Ae(D,6):m=ge(D);const b=`${a.getValues("title")}

${a.getValues("description")}`;let j;try{const M=N==="invest"?0:1;j=await r.createProposal.estimateGas(M,p.address,m,b)}catch(M){console.error("Gas estimation failed:",M),j=lt(1e6)}const C=(await u.provider.getFeeData()).gasPrice||Ae("5","gwei"),A=C*j;k(De(C,"gwei")),S(ve(A))}catch(r){console.error("Error estimating gas:",r),k("Unable to estimate"),S("Unable to estimate")}},ee=async()=>{if(!i||!u){I("Please connect your wallet to create a proposal");return}try{if(E("submitting"),I(null),u){const r=Ke(u),p=d.find(C=>C.symbol===a.getValues("token"));if(!p)throw new Error("Invalid token selected");if(!p.supportedTypes.includes(a.getValues("type")))throw new Error(`${a.getValues("token")} is not supported for ${a.getValues("type")==="invest"?"investment":"divestment"} proposals. DLOOP tokens can only be used in divestment proposals.`);const m=p.address;console.log("Creating proposal with params:",{description:`${a.getValues("title")}

${a.getValues("description")}`,tokenAddress:m,amount:a.getValues("amount")});let b;a.getValues("token")==="DLOOP"||a.getValues("token")==="ETH"?b=ge(a.getValues("amount")):a.getValues("token")==="USDC"?b=Ae(a.getValues("amount"),6):b=ge(a.getValues("amount")),console.log(`Converting ${a.getValues("amount")} ${a.getValues("token")} to wei: ${b.toString()}`);let j,q=a.getValues("title");if(a.getValues("description")&&a.getValues("description").length>0){const A=a.getValues("description").length>500?a.getValues("description").substring(0,500)+"...":a.getValues("description");q=`${a.getValues("title")}

${A}`}console.log("Final proposal description:",q);try{if(a.getValues("type")==="invest")try{const T=new ct(m,["function approve(address spender, uint256 amount) returns (bool)","function allowance(address owner, address spender) view returns (uint256)","function balanceOf(address owner) view returns (uint256)","function decimals() view returns (uint8)","function symbol() view returns (string)"],u),Ye=await T.balanceOf(f);if(console.log(`User balance for ${a.getValues("token")}:`,De(Ye,await T.decimals())),Ye<b)throw new Error(`Insufficient ${a.getValues("token")} balance. You need ${a.getValues("amount")} ${a.getValues("token")} to create this proposal.`);const We=await T.allowance(f,Xe.AssetDAO);if(console.log("Current allowance:",De(We,await T.decimals())),We<b){console.log("Approving tokens for AssetDAO contract..."),V({title:"Token Approval Required",description:`Approving ${a.getValues("amount")} ${a.getValues("token")} for use by the AssetDAO contract. Please confirm this transaction in your wallet.`});const ze=await T.approve(Xe.AssetDAO,b,{gasLimit:3e5});if(B(ze.hash),V({title:"Approval Transaction Submitted",description:"Your approval transaction has been submitted. Waiting for confirmation..."}),(await ze.wait()).status===0)throw new Error("Token approval transaction failed");console.log("Token approval successful"),V({title:"Token Approval Successful",description:`Your ${a.getValues("token")} tokens have been approved for the proposal.`})}}catch(T){throw console.error("Error with token balance or approval:",T),T.message.includes("insufficient")?new Error(`You don't have enough ${a.getValues("token")} tokens for this proposal.`):T.message.includes("user rejected")?new Error("You rejected the token approval. The proposal cannot be created without approving the tokens."):new Error(`Token approval error: ${T.message}`)}const C={gasLimit:1e6},A=a.getValues("type")==="invest"?0:1;a.getValues("type")==="invest"?(console.log("Calling createProposal with:",{proposalType:A,tokenAddress:m,amountInWei:b.toString(),description:q,txOptions:C}),j=await r.createProposal(A,m,b,q,C)):(console.log("Calling createProposal with:",{proposalType:A,tokenAddress:m,amountInWei:b.toString(),description:q,txOptions:C}),j=await r.createProposal(A,m,b,q,C)),B(j.hash),console.log("Transaction submitted:",j.hash);const M=await j.wait();if(console.log("Transaction confirmed:",M),M.status===0)throw new Error("Transaction failed");E("confirmation"),V({title:"Proposal Created Successfully",description:`Your ${a.getValues("type")==="invest"?"investment":"divestment"} proposal has been created.`})}catch(C){console.error("Contract interaction error:",C);const A=C.message||"Unknown contract error";if(console.log("Full contract error details:",{message:C.message,code:C.code,errorArgs:C.errorArgs,errorName:C.errorName,errorSignature:C.errorSignature,reason:C.reason,receipt:C.receipt,transaction:C.transaction}),A.includes("missing revert data"))throw new Error("Transaction failed: The contract rejected the proposal. Common causes include: 1) Insufficient DLOOP token balance (for voting power), 2) You already have an active proposal, or 3) The token amount exceeds treasury limits.");if(A.includes("gas required exceeds allowance")||A.includes("execution reverted")){const M=A.match(/reason="([^"]+)"/),T=M?M[1]:"Unknown reason";throw T.includes("not enough voting power")||T.toLowerCase().includes("insufficient")?new Error("Proposal creation failed: You don't have enough DLOOP tokens staked in the DAO to create this proposal. You need to have DLOOP tokens staked for voting power."):T.includes("proposal already exists")||T.includes("active proposal")?new Error("You already have an active proposal. You cannot create another proposal until your current one is finalized."):T.includes("amount exceeds")||T.includes("treasury")||T.includes("limit")?new Error("The proposal amount exceeds the allowed limits for the treasury. Please try a smaller amount or a different token."):new Error(`Transaction would fail: ${T}. Make sure you have enough ETH for gas and the contract allows this proposal.`)}else{if(A.includes("user rejected transaction"))throw new Error("Transaction was rejected in your wallet.");if(A.includes("insufficient funds"))throw new Error("You don't have enough ETH to cover gas fees for this transaction.");if(A.includes("nonce too high")||A.includes("nonce has already been used"))throw new Error("Wallet nonce issue. Please try refreshing the page and reconnecting your wallet.");if(A.includes("network changed")||A.includes("chain")||A.includes("network"))throw new Error("Network connection issue. Please make sure you're connected to Sepolia testnet.")}throw C}}}catch(r){console.error("Failed to create proposal:",r),I(r.message||"Failed to create proposal"),E("review"),V({title:"Proposal Creation Failed",description:r.message||"An error occurred while creating the proposal.",variant:"destructive"})}},O=()=>{switch(x){case"type":return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsx(J,{children:"Create New Proposal"}),e.jsx(X,{children:"Select the type of proposal you want to create."})]}),e.jsx(Te,{...a,children:e.jsx("div",{className:"space-y-4",children:e.jsx(se,{control:a.control,name:"type",render:({field:r})=>e.jsxs(ae,{className:"space-y-4",children:[e.jsx(re,{children:"Proposal Type"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:`cursor-pointer rounded-lg border-2 p-4 transition-all ${r.value==="invest"?"border-primary bg-primary/10":"border-accent/20 hover:border-accent/60"}`,onClick:()=>a.setValue("type","invest"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold",children:"Investment Proposal"}),r.value==="invest"&&e.jsx(ne,{className:"h-5 w-5 text-primary"})]}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Propose to invest DAO treasury funds into a new digital asset or increase existing asset allocation."})]}),e.jsxs("div",{className:`cursor-pointer rounded-lg border-2 p-4 transition-all ${r.value==="divest"?"border-primary bg-primary/10":"border-accent/20 hover:border-accent/60"}`,onClick:()=>a.setValue("type","divest"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold",children:"Divestment Proposal"}),r.value==="divest"&&e.jsx(ne,{className:"h-5 w-5 text-primary"})]}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Propose to sell a portion of assets from the DAO treasury, reducing exposure to a specific asset."})]})]}),e.jsx(oe,{})]})})})}),e.jsxs(de,{className:"flex justify-end space-x-2",children:[e.jsx(w,{variant:"outline",onClick:h,children:"Cancel"}),e.jsxs(w,{onClick:o,className:"gap-2",children:["Next ",e.jsx(Ee,{className:"h-4 w-4"})]})]})]});case"details":return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsx(J,{children:"Proposal Details"}),e.jsxs(X,{children:["Provide the basic information for your ",N==="invest"?"investment":"divestment"," proposal."]})]}),e.jsx(Te,{...a,children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(se,{control:a.control,name:"title",render:({field:r})=>e.jsxs(ae,{children:[e.jsx(re,{children:"Proposal Title"}),e.jsx(ue,{children:e.jsx($e,{placeholder:`${N==="invest"?"Invest in":"Divest from"} [Asset]`,className:"shadow-sm dark:shadow-zinc-800",...r})}),e.jsx(pe,{children:"Create a clear, concise title (5-100 characters)"}),e.jsx(oe,{})]})}),e.jsx(se,{control:a.control,name:"description",render:({field:r})=>e.jsxs(ae,{children:[e.jsx(re,{children:"Proposal Description"}),e.jsx(ue,{children:e.jsx(wt,{placeholder:"Explain why this proposal should be approved and the expected impact...",className:"min-h-[120px] shadow-sm dark:shadow-zinc-800",...r})}),e.jsx(pe,{children:"Provide a detailed rationale for your proposal (20-2000 characters)"}),e.jsx(oe,{})]})})]})}),e.jsxs(de,{className:"flex justify-between",children:[e.jsxs(w,{variant:"outline",onClick:s,className:"gap-2",children:[e.jsx(Ve,{className:"h-4 w-4"})," Back"]}),e.jsxs(w,{onClick:o,className:"gap-2",children:["Next ",e.jsx(Ee,{className:"h-4 w-4"})]})]})]});case"assets":return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsx(J,{children:"Asset Details"}),e.jsxs(X,{children:["Specify the asset and amount for your ",N==="invest"?"investment":"divestment"," proposal."]})]}),e.jsx(Te,{...a,children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(se,{control:a.control,name:"token",render:({field:r})=>e.jsxs(ae,{children:[e.jsx(re,{children:"Select Asset"}),e.jsxs(Ie,{onValueChange:r.onChange,defaultValue:r.value,children:[e.jsx(ue,{children:e.jsx(Le,{className:"shadow-sm dark:shadow-zinc-800",children:e.jsx(Re,{placeholder:"Select a token"})})}),e.jsx(Be,{children:U.map(p=>e.jsx(K,{value:p.symbol,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:p.symbol}),e.jsx(je,{variant:"outline",className:"ml-2 text-xs",children:ye(p.address)})]})},p.symbol))})]}),e.jsx(pe,{children:N==="invest"?"Select which asset to add to the treasury":"Select which asset to sell from the treasury"}),e.jsx(oe,{})]})}),e.jsx(se,{control:a.control,name:"amount",render:({field:r})=>e.jsxs(ae,{children:[e.jsx(re,{children:"Amount"}),e.jsx(ue,{children:e.jsxs("div",{className:"flex items-center",children:[e.jsx($e,{type:"text",inputMode:"decimal",pattern:"[0-9]*[.,]?[0-9]*",placeholder:"0.00",...r,className:"rounded-r-none shadow-sm dark:shadow-zinc-800",onChange:p=>{const m=p.target.value.replace(/[^0-9.]/g,""),b=m.split("."),j=b.length>1?`${b[0]}.${b.slice(1).join("")}`:m;r.onChange(j)}}),e.jsx("div",{className:"bg-muted px-3 py-2 border border-l-0 rounded-r-md",children:y||"Token"})]})}),e.jsx(pe,{children:N==="invest"?"The amount to allocate to this asset":"The amount to divest from this asset"}),e.jsx(oe,{})]})}),e.jsx(se,{control:a.control,name:"duration",render:({field:r})=>e.jsxs(ae,{children:[e.jsx(re,{children:"Voting Duration"}),e.jsxs(Ie,{onValueChange:r.onChange,defaultValue:r.value,children:[e.jsx(ue,{children:e.jsx(Le,{className:"shadow-sm dark:shadow-zinc-800",children:e.jsx(Re,{placeholder:"Select duration"})})}),e.jsxs(Be,{children:[e.jsx(K,{value:"3",children:"3 Days"}),e.jsx(K,{value:"5",children:"5 Days"}),e.jsx(K,{value:"7",children:"7 Days"}),e.jsx(K,{value:"14",children:"14 Days"})]})]}),e.jsx(pe,{children:"How long the proposal will be open for voting"}),e.jsx(oe,{})]})})]})}),e.jsxs(de,{className:"flex justify-between",children:[e.jsxs(w,{variant:"outline",onClick:s,className:"gap-2",children:[e.jsx(Ve,{className:"h-4 w-4"})," Back"]}),e.jsxs(w,{onClick:o,className:"gap-2",children:["Review ",e.jsx(Ee,{className:"h-4 w-4"})]})]})]});case"review":return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Q,{children:[e.jsx(J,{children:"Review Proposal"}),e.jsx(X,{children:"Review your proposal before submission."})]}),e.jsxs("div",{className:"space-y-4",children:[H&&e.jsxs(Y,{variant:"destructive",children:[e.jsx(Ze,{className:"h-4 w-4"}),e.jsx(W,{children:"Error"}),e.jsx(z,{children:H})]}),e.jsxs(we,{children:[e.jsxs(Ne,{className:"pb-2",children:[e.jsx(Me,{className:"text-lg",children:a.getValues("title")}),e.jsx(je,{children:N==="invest"?"Investment":"Divestment"})]}),e.jsxs(Pe,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground mb-1",children:"Description"}),e.jsx("p",{className:"text-sm whitespace-pre-line",children:a.getValues("description")})]}),e.jsx(kt,{}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground mb-1",children:"Asset"}),e.jsx("p",{className:"font-medium",children:a.getValues("token")})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground mb-1",children:"Amount"}),e.jsxs("p",{className:"font-medium",children:[a.getValues("amount")," ",a.getValues("token")]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground mb-1",children:"Voting Duration"}),e.jsxs("p",{className:"font-medium",children:[a.getValues("duration")," days"]})]})]})]})]}),e.jsxs(we,{children:[e.jsx(Ne,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Me,{className:"text-sm font-medium",children:"Estimated Transaction Cost"}),e.jsx(It,{className:"h-4 w-4 text-muted-foreground"})]})}),e.jsx(Pe,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsx("div",{className:"text-muted-foreground",children:"Gas Price:"}),e.jsx("div",{className:"font-medium text-right",children:G?`${G} Gwei`:"Calculating..."}),e.jsx("div",{className:"text-muted-foreground",children:"Estimated Cost:"}),e.jsx("div",{className:"font-medium text-right",children:R?`${R} ETH`:"Calculating..."})]})})]})]}),e.jsxs(de,{className:"flex justify-between",children:[e.jsxs(w,{variant:"outline",onClick:s,className:"gap-2",children:[e.jsx(Ve,{className:"h-4 w-4"})," Back"]}),e.jsx(w,{onClick:o,disabled:F,className:"gap-2",children:F?e.jsxs(e.Fragment,{children:[e.jsx(et,{className:"mr-2 h-4 w-4 animate-spin"}),"Submitting"]}):e.jsx(e.Fragment,{children:"Submit Proposal"})})]})]});case"submitting":return e.jsxs("div",{className:"space-y-6 flex flex-col items-center justify-center py-8",children:[e.jsxs(Q,{className:"text-center",children:[e.jsx(J,{children:"Creating Your Proposal"}),e.jsx(X,{children:"Please wait while we submit your proposal to the blockchain."})]}),e.jsxs("div",{className:"w-[80px] h-[80px] relative flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin h-full w-full border-4 border-t-primary border-l-primary border-b-primary border-r-transparent rounded-full"}),e.jsx(Dt,{className:"h-10 w-10 text-primary absolute"})]}),e.jsx("div",{className:"text-center",children:v?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"mb-2",children:"Transaction submitted:"}),e.jsx("a",{href:`https://sepolia.etherscan.io/tx/${v}`,target:"_blank",rel:"noopener noreferrer",className:"text-accent underline break-all",children:v})]}):e.jsx("p",{children:"Waiting for wallet confirmation..."})})]});case"confirmation":return e.jsxs("div",{className:"space-y-6 flex flex-col items-center justify-center py-8",children:[e.jsx("div",{className:"w-[80px] h-[80px] rounded-full bg-green-100 flex items-center justify-center mb-4",children:e.jsx(ne,{className:"h-12 w-12 text-green-600"})}),e.jsxs(Q,{className:"text-center",children:[e.jsx(J,{children:"Proposal Created Successfully!"}),e.jsxs(X,{children:["Your ",N==="invest"?"investment":"divestment"," proposal has been submitted to the DAO."]})]}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("p",{children:"You can view your proposal on the blockchain:"}),e.jsx("a",{href:`https://sepolia.etherscan.io/tx/${v}`,target:"_blank",rel:"noopener noreferrer",className:"text-accent underline break-all",children:v}),e.jsxs("div",{className:"flex flex-col pt-4 gap-2",children:[e.jsxs(w,{onClick:h,className:"gap-2",children:[e.jsx(ne,{className:"h-4 w-4"})," Done"]}),e.jsx(w,{variant:"outline",onClick:()=>{h()},children:"View All Proposals"})]})]})]});default:return null}};return e.jsxs(bt,{open:t,onOpenChange:h,children:[!i&&x==="type"&&e.jsxs(fe,{className:"bg-dark-gray text-white border-gray max-w-md",forceMount:!0,children:[e.jsxs(Q,{children:[e.jsx(J,{children:"Wallet Not Connected"}),e.jsx(X,{children:"You need to connect your wallet to create a proposal."})]}),e.jsx("div",{className:"my-4",children:e.jsxs(Y,{children:[e.jsx(Ze,{className:"h-4 w-4"}),e.jsx(W,{children:"Connection Required"}),e.jsx(z,{children:"Please connect your wallet to interact with the DAO."})]})}),e.jsx(de,{children:e.jsx(w,{onClick:h,children:"Close"})})]}),i&&x!=="submitting"&&x!=="confirmation"&&e.jsxs(fe,{className:"sm:max-w-[550px]",forceMount:!0,children:[["type","details","assets","review"].includes(x)&&e.jsxs("div",{className:"mb-4",children:[e.jsx(Nt,{value:n(),className:"h-2"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsx("span",{className:x==="type"?"font-medium text-primary":"",children:"Type"}),e.jsx("span",{className:x==="details"?"font-medium text-primary":"",children:"Details"}),e.jsx("span",{className:x==="assets"?"font-medium text-primary":"",children:"Assets"}),e.jsx("span",{className:x==="review"?"font-medium text-primary":"",children:"Review"})]})]}),O()]}),x==="submitting"&&e.jsx(fe,{className:"bg-dark-gray text-white border-gray max-w-md",forceMount:!0,children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 space-y-4",children:[e.jsx(et,{className:"h-16 w-16 animate-spin text-accent"}),e.jsx("h2",{className:"text-xl font-semibold mt-4",children:"Creating Proposal"}),e.jsx("p",{className:"text-center text-muted-foreground",children:"Please wait while your proposal is being submitted to the blockchain."}),v&&e.jsxs("div",{className:"mt-4 text-center",children:[e.jsx("p",{className:"mb-2 text-sm text-muted-foreground",children:"Transaction:"}),e.jsx("a",{href:`https://sepolia.etherscan.io/tx/${v}`,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-accent hover:underline break-all",children:v})]})]})}),x==="confirmation"&&v&&e.jsx(fe,{className:"bg-dark-gray text-white border-gray max-w-md",forceMount:!0,children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-6",children:[e.jsx("div",{className:"rounded-full bg-green-500/20 p-3",children:e.jsx(ne,{className:"h-10 w-10 text-green-500"})}),e.jsx("h2",{className:"text-xl font-semibold mt-4",children:"Proposal Created!"}),e.jsxs("p",{className:"text-center text-muted-foreground mt-2 mb-4",children:["Your ",a.getValues("type")==="invest"?"investment":"divestment"," proposal has been created successfully."]}),e.jsxs("div",{className:"bg-accent/10 rounded-lg p-4 w-full mt-2",children:[e.jsx("p",{className:"font-medium mb-1",children:a.getValues("title")}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-3",children:[a.getValues("amount")," ",a.getValues("token")," • ",a.getValues("duration")," days voting period"]}),e.jsx("a",{href:`https://sepolia.etherscan.io/tx/${v}`,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-accent hover:underline",children:"View on Etherscan →"})]}),e.jsxs("div",{className:"flex gap-3 mt-6 w-full",children:[e.jsx(w,{variant:"outline",className:"flex-1",onClick:h,children:"Close"}),e.jsx(w,{className:"flex-1",onClick:()=>{h()},children:"View All Proposals"})]})]})})]})}function zt(){const{proposals:t,isLoading:l,error:i,refetchProposals:f,voteOnProposal:u,executeProposal:$}=qe(),{isConnected:F}=Ue(),{toast:V}=rt(),[H,I]=P.useState(!1),[v,B]=P.useState({status:"all",type:"all",search:""}),[x,E]=P.useState("active");dt.useEffect(()=>{t&&t.length>0?(console.log("Debug - Proposal statuses:",t.map(o=>o.status)),console.log("Active proposals:",t.filter(o=>o.status==="active").length),console.log("Passed proposals:",t.filter(o=>o.status==="passed").length),console.log("Executed proposals:",t.filter(o=>o.status==="executed").length),console.log("Failed proposals:",t.filter(o=>o.status==="failed").length)):console.log("Waiting for proposals data to load...")},[t]);const[R,S]=P.useState(!1),G=async()=>{S(!0),await f(),S(!1),V({title:"Proposals Refreshed",description:"The proposal list has been updated."})},k=o=>{if(!t)return[];const s=O=>{var r,p;return!(v.type!=="all"&&O.type!==v.type||v.search&&!((r=O.title)!=null&&r.toLowerCase().includes(v.search.toLowerCase()))&&!((p=O.description)!=null&&p.toLowerCase().includes(v.search.toLowerCase())))},c=t.filter(s);if(o==="all")return c;const ee=O=>{if(!O.deadline){if(O.createdAt)try{const r=new Date(O.createdAt),p=3*24*60*60*1e3,m=new Date(r.getTime()+p);return new Date>m}catch{return!1}return!1}try{const r=new Date(O.deadline);return new Date>r}catch{return!1}};return c.filter(O=>{var p;const r=(p=O.status)==null?void 0:p.toLowerCase();return o==="active"?r==="active"&&!ee(O):o==="failed"?r==="failed"||r==="active"&&ee(O):r===o})};k(x);const d=(t==null?void 0:t.length)||0,a=k("active"),N=k("passed"),y=k("executed"),D=k("failed"),U=a.length,n=N.length,g=y.length,h=D.length;return t&&t.length>0&&(console.log("Debug - Proposal counts by tab:"),console.log(`All: ${d}, Active: ${U}, Passed: ${n}, Executed: ${g}, Failed: ${h}`),console.log("Debug - Proposal #53 in Active tab:",a.some(o=>o.id===53))),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold relative inline-block group",children:["Asset DAO Proposals",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/80 transition-all duration-500 group-hover:w-full"})]}),e.jsx("p",{className:"text-gray group-hover:text-gray/90 transition-colors duration-300",children:"View, vote, and create proposals to optimize the D-AI reserve pool."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{}),e.jsxs(w,{variant:"outline",size:"sm",className:"bg-dark-bg border-gray text-white hover:border-accent transition-all duration-300 hover:shadow-sm hover:translate-y-[-1px]",onClick:G,disabled:R,children:[e.jsx(Vt,{className:`h-4 w-4 mr-2 ${R?"animate-spin":""} transition-transform duration-300 group-hover:rotate-180`}),e.jsx("span",{className:"transition-transform duration-300 hover:translate-x-0.5",children:"Refresh"})]}),e.jsxs(w,{onClick:()=>I(!0),className:"bg-accent text-dark-bg hover:bg-darker-accent transition-all duration-300 hover:shadow-md hover:translate-y-[-1px] relative overflow-hidden group",disabled:!F,children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-accent/0 via-accent/30 to-accent/0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 group-hover:animate-pulse"}),e.jsx(Se,{className:"h-4 w-4 mr-2 transition-transform duration-300 group-hover:rotate-90"}),e.jsx("span",{className:"relative z-10 transition-transform duration-300 group-hover:translate-x-0.5",children:"Create Proposal"})]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-grow group",children:[e.jsx(Lt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray transition-colors duration-300 group-focus-within:text-accent"}),e.jsx($e,{placeholder:"Search proposals...",className:"pl-10 bg-dark-bg border-gray text-white focus-visible:ring-accent transition-all duration-300 focus:translate-y-[-1px] focus:shadow-sm",value:v.search,onChange:o=>B({...v,search:o.target.value})})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(Ie,{value:v.type,onValueChange:o=>B({...v,type:o}),children:[e.jsx(Le,{className:"w-[180px] bg-dark-bg border-gray text-white focus:ring-accent transition-all duration-300 hover:border-accent/70 hover:shadow-sm",children:e.jsx(Re,{placeholder:"Filter by type"})}),e.jsxs(Be,{className:"bg-dark-bg border-gray text-white animate-in fade-in-80 zoom-in-95",children:[e.jsx(K,{value:"all",className:"transition-colors duration-200 hover:bg-accent/10 focus:bg-accent/20",children:"All Types"}),e.jsx(K,{value:"invest",className:"transition-colors duration-200 hover:bg-accent/10 focus:bg-accent/20",children:"Invest"}),e.jsx(K,{value:"divest",className:"transition-colors duration-200 hover:bg-accent/10 focus:bg-accent/20",children:"Divest"})]})]})})]}),e.jsxs(Tt,{defaultValue:"active",value:x,className:"w-full",children:[e.jsx("div",{onChange:o=>E(o.target.value),style:{display:"none"}}),e.jsxs(Et,{className:"bg-dark-bg border border-gray rounded-lg p-1 w-full overflow-x-auto flex-nowrap",children:[e.jsxs(me,{value:"active",className:"flex-1 data-[state=active]:bg-dark-gray data-[state=active]:text-white transition-all duration-300 hover:bg-gray/10 data-[state=active]:shadow-sm relative group",children:[e.jsxs("span",{className:"relative",children:["Active",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 opacity-0 group-hover:opacity-100 data-[state=active]:opacity-100 group-hover:w-full data-[state=active]:w-full"})]}),e.jsx("span",{className:"ml-1.5 text-xs bg-dark-gray px-1.5 py-0.5 rounded-full transition-transform duration-300 group-hover:scale-110",children:U})]}),e.jsxs(me,{value:"passed",className:"flex-1 data-[state=active]:bg-dark-gray data-[state=active]:text-white transition-all duration-300 hover:bg-gray/10 data-[state=active]:shadow-sm relative group",children:[e.jsxs("span",{className:"relative",children:["Passed",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 opacity-0 group-hover:opacity-100 data-[state=active]:opacity-100 group-hover:w-full data-[state=active]:w-full"})]}),e.jsx("span",{className:"ml-1.5 text-xs bg-dark-gray px-1.5 py-0.5 rounded-full transition-transform duration-300 group-hover:scale-110",children:n})]}),e.jsxs(me,{value:"executed",className:"flex-1 data-[state=active]:bg-dark-gray data-[state=active]:text-white transition-all duration-300 hover:bg-gray/10 data-[state=active]:shadow-sm relative group",children:[e.jsxs("span",{className:"relative",children:["Executed",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 opacity-0 group-hover:opacity-100 data-[state=active]:opacity-100 group-hover:w-full data-[state=active]:w-full"})]}),e.jsx("span",{className:"ml-1.5 text-xs bg-dark-gray px-1.5 py-0.5 rounded-full transition-transform duration-300 group-hover:scale-110",children:g})]}),e.jsxs(me,{value:"failed",className:"flex-1 data-[state=active]:bg-dark-gray data-[state=active]:text-white transition-all duration-300 hover:bg-gray/10 data-[state=active]:shadow-sm relative group",children:[e.jsxs("span",{className:"relative",children:["Failed",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 opacity-0 group-hover:opacity-100 data-[state=active]:opacity-100 group-hover:w-full data-[state=active]:w-full"})]}),e.jsx("span",{className:"ml-1.5 text-xs bg-dark-gray px-1.5 py-0.5 rounded-full transition-transform duration-300 group-hover:scale-110",children:h})]}),e.jsxs(me,{value:"all",className:"flex-1 data-[state=active]:bg-dark-gray data-[state=active]:text-white transition-all duration-300 hover:bg-gray/10 data-[state=active]:shadow-sm relative group",children:[e.jsxs("span",{className:"relative",children:["All",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 opacity-0 group-hover:opacity-100 data-[state=active]:opacity-100 group-hover:w-full data-[state=active]:w-full"})]}),e.jsx("span",{className:"ml-1.5 text-xs bg-dark-gray px-1.5 py-0.5 rounded-full transition-transform duration-300 group-hover:scale-110",children:d})]})]}),e.jsxs(he,{value:"active",className:"mt-6",children:[i&&e.jsxs(Y,{variant:"destructive",className:"mb-6 bg-destructive/20 border-destructive",children:[e.jsx(W,{children:"Error loading proposals"}),e.jsx(z,{children:i instanceof Error?i.message:"An unknown error occurred"})]}),l?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent"})}):(t==null?void 0:t.filter(o=>o.status==="active").length)===0?e.jsxs("div",{className:"text-center py-12 border border-dashed border-gray rounded-lg transition-all duration-500 hover:border-accent/40 hover:shadow-md",children:[e.jsxs("h3",{className:"text-xl font-medium text-white mb-2 relative inline-block group",children:["No active proposals",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 group-hover:w-full"})]}),e.jsx("p",{className:"text-gray mb-6 transition-colors duration-300 max-w-md mx-auto",children:"There are currently no proposals in the voting period"}),F&&e.jsxs(w,{onClick:()=>I(!0),className:"bg-accent text-dark-bg hover:bg-darker-accent transition-all duration-300 hover:shadow-md hover:translate-y-[-1px] relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-accent/0 via-accent/30 to-accent/0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 group-hover:animate-pulse"}),e.jsx(Se,{className:"h-4 w-4 mr-2 transition-transform duration-300 group-hover:rotate-90"}),e.jsx("span",{className:"relative z-10 transition-transform duration-300 group-hover:translate-x-0.5",children:"Create New Proposal"})]})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:k("active").map(o=>e.jsx(le,{proposal:o,onVote:(s,c)=>u({proposalId:s,support:c}),onExecute:s=>$(s),onActionComplete:f},o.id))})]}),e.jsxs(he,{value:"passed",className:"mt-6",children:[i&&e.jsxs(Y,{variant:"destructive",className:"mb-6 bg-destructive/20 border-destructive",children:[e.jsx(W,{children:"Error loading proposals"}),e.jsx(z,{children:i instanceof Error?i.message:"An unknown error occurred"})]}),l?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent"})}):(t==null?void 0:t.filter(o=>o.status==="passed").length)===0?e.jsxs("div",{className:"text-center py-12 border border-dashed border-gray rounded-lg transition-all duration-500 hover:border-accent/40 hover:shadow-md",children:[e.jsxs("h3",{className:"text-xl font-medium text-white mb-2 relative inline-block group",children:["No passed proposals",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 group-hover:w-full"})]}),e.jsx("p",{className:"text-gray mb-6 transition-colors duration-300 max-w-md mx-auto",children:"There are currently no proposals that have passed but not yet executed"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:k("passed").map(o=>e.jsx(le,{proposal:o,onVote:(s,c)=>u({proposalId:s,support:c}),onExecute:s=>$(s),onActionComplete:f},o.id))})]}),e.jsxs(he,{value:"executed",className:"mt-6",children:[i&&e.jsxs(Y,{variant:"destructive",className:"mb-6 bg-destructive/20 border-destructive",children:[e.jsx(W,{children:"Error loading proposals"}),e.jsx(z,{children:i instanceof Error?i.message:"An unknown error occurred"})]}),l?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent"})}):(t==null?void 0:t.filter(o=>o.status==="executed").length)===0?e.jsxs("div",{className:"text-center py-12 border border-dashed border-gray rounded-lg transition-all duration-500 hover:border-accent/40 hover:shadow-md",children:[e.jsxs("h3",{className:"text-xl font-medium text-white mb-2 relative inline-block group",children:["No executed proposals",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 group-hover:w-full"})]}),e.jsx("p",{className:"text-gray mb-6 transition-colors duration-300 max-w-md mx-auto",children:"There are currently no executed proposals"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:k("executed").map(o=>e.jsx(le,{proposal:o,onVote:(s,c)=>u({proposalId:s,support:c}),onExecute:s=>$(s),onActionComplete:f},o.id))})]}),e.jsxs(he,{value:"failed",className:"mt-6",children:[i&&e.jsxs(Y,{variant:"destructive",className:"mb-6 bg-destructive/20 border-destructive",children:[e.jsx(W,{children:"Error loading proposals"}),e.jsx(z,{children:i instanceof Error?i.message:"An unknown error occurred"})]}),l?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent"})}):k("failed").length===0?e.jsxs("div",{className:"text-center py-12 border border-dashed border-gray rounded-lg transition-all duration-500 hover:border-accent/40 hover:shadow-md",children:[e.jsxs("h3",{className:"text-xl font-medium text-white mb-2 relative inline-block group",children:["No failed proposals",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 group-hover:w-full"})]}),e.jsx("p",{className:"text-gray mb-6 transition-colors duration-300 max-w-md mx-auto",children:"There are currently no failed or defeated proposals"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:k("failed").map(o=>e.jsx(le,{proposal:o,onVote:(s,c)=>u({proposalId:s,support:c}),onExecute:s=>$(s),onActionComplete:f},o.id))})]}),e.jsxs(he,{value:"all",className:"mt-6",children:[i&&e.jsxs(Y,{variant:"destructive",className:"mb-6 bg-destructive/20 border-destructive",children:[e.jsx(W,{children:"Error loading proposals"}),e.jsx(z,{children:i instanceof Error?i.message:"An unknown error occurred"})]}),l?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent"})}):k("all").length===0?e.jsxs("div",{className:"text-center py-12 border border-dashed border-gray rounded-lg transition-all duration-500 hover:border-accent/40 hover:shadow-md",children:[e.jsxs("h3",{className:"text-xl font-medium text-white mb-2 relative inline-block group",children:["No proposals found",e.jsx("span",{className:"absolute -bottom-1 left-0 w-0 h-0.5 bg-accent/60 transition-all duration-500 group-hover:w-full"})]}),e.jsx("p",{className:"text-gray mb-6 transition-colors duration-300 max-w-md mx-auto",children:v.search||v.type!=="all"?"Try adjusting your filters to see more results":"Be the first to submit a proposal for this DAO"}),F&&e.jsxs(w,{onClick:()=>I(!0),className:"bg-accent text-dark-bg hover:bg-darker-accent transition-all duration-300 hover:shadow-md hover:translate-y-[-1px] relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-accent/0 via-accent/30 to-accent/0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 group-hover:animate-pulse"}),e.jsx(Se,{className:"h-4 w-4 mr-2 transition-transform duration-300 group-hover:rotate-90"}),e.jsx("span",{className:"relative z-10 transition-transform duration-300 group-hover:translate-x-0.5",children:"Create New Proposal"})]})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:k("all").map(o=>e.jsx(le,{proposal:o,onVote:(s,c)=>u({proposalId:s,support:c}),onExecute:s=>$(s),onActionComplete:f},o.id))})]})]}),e.jsx(Wt,{isOpen:H,onClose:()=>I(!1)})]})}function Gt({proposalId:t}){const l=parseInt(t,10),{isConnected:i,provider:f,signer:u}=Ue(),{proposals:$=[],refetchProposals:F}=qe(),[V,H]=P.useState(!0),[,I]=at(),[v,B]=P.useState(!1),[x,E]=P.useState(null),[R,S]=P.useState(!1),[G,k]=P.useState(!1);P.useEffect(()=>{const s=setTimeout(()=>{H(!1)},1e3);return()=>clearTimeout(s)},[]),P.useEffect(()=>{const s=JSON.parse(localStorage.getItem("votedProposals")||"{}");s[l]&&(B(!0),E(s[l]))},[l]);const d=$.find(s=>s.id===l),a=async s=>{if(!i){L.error("Please connect your wallet first.");return}if(!u){L.error("Signer not available. Please reconnect your wallet.");return}S(!0);try{await be.voteOnProposal(u,l,s);const c=JSON.parse(localStorage.getItem("votedProposals")||"{}");c[l]=s,localStorage.setItem("votedProposals",JSON.stringify(c)),L.success(`Successfully voted ${s?"FOR":"AGAINST"} the proposal`),B(!0),E(s),F()}catch(c){L.error(c.message||"There was an error casting your vote. Please try again.")}finally{S(!1)}},N=async()=>{if(!i){L.error("Please connect your wallet to execute this proposal.");return}if(!u){L.error("Signer not available. Please reconnect your wallet.");return}k(!0);try{await be.executeProposal(u,l),L.success("Proposal executed successfully!"),F()}catch(s){L.error(s.message||"There was an error executing the proposal. Please try again.")}finally{k(!1)}},y=s=>{switch(s){case"active":return"default";case"passed":return"default";case"failed":return"destructive";case"executed":return"secondary";default:return"secondary"}},D=s=>{if(s==null)return"Unknown";const c=typeof s=="string"?s.toLowerCase():typeof s=="number"?s:-1;if(typeof c=="number")switch(c){case 0:case te.Investment:return"Invest";case 1:case te.Divestment:return"Divest";case 2:case te.ParameterChange:return"Parameter Change";default:return"Other"}return c==="investment"||c==="invest"||c==="0"?"Invest":c==="divestment"||c==="divest"||c==="1"?"Divest":c==="parameterchange"||c==="parameter"||c==="2"?"Parameter Change":"Other"},U=s=>{if(typeof s=="number")switch(s){case te.Investment:return"default";case te.Divestment:return"destructive";case te.ParameterChange:return"secondary";default:return"secondary"}const c=String(s).toLowerCase();return c==="invest"||c==="investment"||c==="0"?"default":c==="divest"||c==="divestment"||c==="1"?"destructive":"secondary"};if(V)return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(Oe,{title:"",description:"",children:[e.jsx(Z,{className:"h-8 w-[200px]"}),e.jsx(Z,{className:"h-4 w-[300px]"})]}),e.jsxs(we,{children:[e.jsxs(Ne,{children:[e.jsx(Z,{className:"h-6 w-[150px]"}),e.jsx(Z,{className:"h-4 w-[200px]"})]}),e.jsxs(Pe,{className:"space-y-4",children:[e.jsx(Z,{className:"h-24 w-full"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[1,2,3,4].map(s=>e.jsxs("div",{children:[e.jsx(Z,{className:"h-4 w-[50px]"}),e.jsx(Z,{className:"h-6 w-[100px] mt-1"})]},s))})]})]})]});if(!d)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Oe,{title:"Proposal Not Found",description:"The proposal you're looking for doesn't exist or has been removed.",actions:e.jsxs(w,{variant:"outline",onClick:()=>I("/asset-dao"),children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),"Back to Proposals"]})}),e.jsxs(Y,{variant:"destructive",children:[e.jsx(St,{className:"h-4 w-4"}),e.jsx(W,{children:"Error"}),e.jsxs(z,{children:["We couldn't find a proposal with ID ",l,". Please check the ID and try again."]})]})]});const n=d.status==="active",g=d.status==="passed",h=Math.round(d.forVotes/(d.forVotes+d.againstVotes||1)*100),o=Math.round(d.againstVotes/(d.forVotes+d.againstVotes||1)*100);return e.jsxs("div",{className:"space-y-6",children:[e.jsx(Oe,{title:d.title||"",description:`Proposal #${d.id} | Created by ${ye(d.proposer)}`,actions:e.jsx(pt,{href:"/asset-dao",children:e.jsxs(w,{variant:"outline",children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),"Back to Proposals"]})})}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[e.jsx(je,{variant:U(d.type),children:D(d.type)}),e.jsx(je,{variant:y(d.status),children:d.status.charAt(0).toUpperCase()+d.status.slice(1)})]}),e.jsxs(we,{children:[e.jsxs(Ne,{children:[e.jsx(Me,{children:"Proposal Details"}),e.jsxs(Pt,{children:["Created on ",_e(d.createdAt)," by ",ye(d.proposer)]})]}),e.jsxs(Pe,{className:"space-y-6",children:[e.jsx("p",{children:d.description}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Proposer:"}),e.jsx("p",{className:"text-sm font-medium",children:ye(d.proposer)}),e.jsx("button",{onClick:()=>{mt(d.proposer),L.success("Address copied to clipboard!")},className:"text-primary hover:text-primary/80 transition-colors",children:e.jsx(Ot,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 py-4 border-t border-b",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Asset"}),e.jsx("p",{className:"font-medium",children:xt.getTokenSymbol(d.token)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Amount"}),e.jsxs("p",{className:"font-medium",children:["$",d.amount.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:n?"Ends in":"Ended on"}),e.jsx("p",{className:"font-medium",children:n?st(d.endTime):_e(d.endTime)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Status"}),e.jsx("p",{className:"font-medium capitalize",children:d.status})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Voting Results"}),e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsxs("span",{className:"text-sm",children:["For: ",h,"% (",d.forVotes.toLocaleString(),")"]}),e.jsxs("span",{className:"text-sm",children:["Against: ",o,"% (",d.againstVotes.toLocaleString(),")"]})]}),e.jsx("div",{className:"relative w-full h-4 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"absolute left-0 top-0 h-full bg-primary",style:{width:`${h}%`}})})]}),v&&e.jsxs(Y,{children:[x?e.jsx(Ft,{className:"h-4 w-4 text-primary"}):e.jsx(At,{className:"h-4 w-4 text-destructive"}),e.jsx(W,{children:"You've voted on this proposal"}),e.jsxs(z,{children:["You voted ",x?"FOR":"AGAINST"," this proposal."]})]}),n&&!v&&e.jsxs(Y,{children:[e.jsx($t,{className:"h-4 w-4"}),e.jsx(W,{children:"Voting is open"}),e.jsx(z,{children:"Cast your vote on this proposal. Voting power is determined by your token holdings."})]})]}),e.jsxs(Ct,{className:"flex justify-between",children:[n&&!v&&e.jsxs("div",{className:"flex gap-2 w-full justify-end",children:[e.jsx(w,{variant:"destructive",onClick:()=>a(!1),disabled:R||!i,children:R?"Voting...":"Vote No"}),e.jsx(w,{onClick:()=>a(!0),disabled:R||!i,children:R?"Voting...":"Vote Yes"})]}),g&&!d.executed&&e.jsx("div",{className:"w-full flex justify-end",children:e.jsx(w,{onClick:N,disabled:G||!i,children:G?"Executing...":"Execute Proposal"})}),d.executed&&e.jsx("div",{className:"w-full flex justify-end",children:e.jsxs(w,{disabled:!0,variant:"outline",children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Executed"]})}),d.status==="failed"&&e.jsx("div",{className:"w-full flex justify-end",children:e.jsxs(w,{disabled:!0,variant:"outline",className:"text-destructive",children:[e.jsx(ht,{className:"mr-2 h-4 w-4"}),"Failed"]})})]})]})]})}function As(){const[t]=at();if(t.startsWith("/asset-dao/proposal/")){const i=t.split("/").pop()||"";return e.jsxs(Je,{children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold",children:"Asset DAO"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Proposal Details"})]}),e.jsx(Gt,{proposalId:i})]})}return e.jsx(Je,{children:e.jsx(zt,{})})}export{As as default};
