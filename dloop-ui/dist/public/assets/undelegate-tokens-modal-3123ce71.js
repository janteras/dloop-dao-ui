import{e as oe,u as D,r as O,D as V,c as ie,H as I,s as $,j as e,a0 as d,a2 as F,B as N,i as le,ac as ce}from"./index-971aa118.js";import{o as H,c as M,u as R,C as de,t as Y}from"./index-e4e6a023.js";import{u as q}from"./PageContainer-a070ff6e.js";import{D as W,a as _,b as G,c as Z,d as K,L as A,I as z,e as J}from"./label-d4220aab.js";import{T as Q}from"./tokenDelegationService-8c6507b8.js";import{A as S}from"./activity-da0d5bb5.js";import{A as me}from"./page-header-f6ee8f2a.js";import{f as ue}from"./api-utils-9109dbff.js";import{a as ge}from"./contracts-444c63f0.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=oe("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),X=()=>{const{signer:l,address:o,isConnected:n}=D(),[i,m]=O.useState(!1),u={participants:[{address:o||"0x7C3fA98507fFcD22A62264AeC6afA82099d96DE1",name:o?"You":"AI.Gov#01",type:"Human",votingPower:425e3,accuracy:92,isCurrentUser:!!o,rank:1,delegators:15,performance:18.4,proposalsCreated:22,proposalsVoted:38},{address:"0x9E23fA851681545894f3B3c33BD1E7D22239BDE8",name:"DeFiWhale",type:"Human",votingPower:375e3,accuracy:88,isCurrentUser:!1,rank:2,delegators:8,performance:14.2,proposalsCreated:11,proposalsVoted:35},{address:"0x3A4B670Be17F3a36F8F55BF7C3c7453495A04Ed1",name:"AI.Gov#02",type:"AI Node",votingPower:31e4,accuracy:95,isCurrentUser:!1,rank:3,delegators:12,performance:22.7,proposalsCreated:14,proposalsVoted:48},{address:"0x4B670B1a36F8F55BF7C3c7453495A04EdF3A4576",name:"CryptoSage",type:"Human",votingPower:285e3,accuracy:87,isCurrentUser:!1,rank:4,delegators:7,performance:12.8,proposalsCreated:9,proposalsVoted:27},{address:"0x5C781D367fE20523Be90986CDC75F88B8a0B4546",name:"AI.Gov#03",type:"AI Node",votingPower:26e4,accuracy:93,isCurrentUser:!1,rank:5,delegators:9,performance:19.6,proposalsCreated:12,proposalsVoted:42}],delegations:[{nodeId:"node-1",address:"0x7C3fA98507fFcD22A62264AeC6afA82099d96DE1",amount:12500,since:"2025-03-15T12:00:00Z"},{nodeId:"node-3",address:"0x9E23fA851681545894f3B3c33BD1E7D22239BDE8",amount:7500,since:"2025-04-02T15:30:00Z"},{nodeId:"node-2",address:"0x3A4B670Be17F3a36F8F55BF7C3c7453495A04Ed1",amount:5e3,since:"2025-02-28T09:15:00Z"}]},{data:s,isLoading:c,error:p,refetch:h}=V({queryKey:["leaderboard"],queryFn:async()=>{try{const t=await ue("/api/leaderboard",void 0,u);if(console.log("Leaderboard data received:",t),!t)return console.log("No leaderboard data received, using mock data"),u;let a=[],r=[];return t.participants?(a=Array.isArray(t.participants)?t.participants:[],r=Array.isArray(t.delegations)?t.delegations:[],console.log(`Found structured data: ${a.length} participants, ${r.length} delegations`)):Array.isArray(t)&&(a=t,console.log(`Found array data: ${a.length} items`)),o&&a.length>0&&(a=a.map(w=>{var x;return{...w,isCurrentUser:((x=w.address)==null?void 0:x.toLowerCase())===o.toLowerCase()}})),!a||a.length===0?(console.log("No participants found in API response - Using mock leaderboard data"),u):{participants:a,delegations:r}}catch(t){return console.error("Error fetching leaderboard data:",t),console.log("Using mock data as fallback after error"),u}},enabled:!0,staleTime:60*1e3}),f=async(t,a)=>{if(!n||!l)throw new Error("Wallet not connected");try{return m(!0),console.log(`Delegating ${a} DLOOP to ${t}`),await new Promise(r=>setTimeout(r,2e3)),await h(),!0}catch(r){throw console.error("Error delegating tokens:",r),r}finally{m(!1)}},g=async(t,a)=>{if(!n||!l)throw new Error("Wallet not connected");try{return m(!0),console.log(`Undelegating ${a} DLOOP from ${t}`),await new Promise(r=>setTimeout(r,2e3)),await h(),!0}catch(r){throw console.error("Error undelegating tokens:",r),r}finally{m(!1)}};return{participants:(s==null?void 0:s.participants)||[],delegations:(s==null?void 0:s.delegations)||[],isLoading:c,error:p,refetch:h,delegateTokens:f,undelegateTokens:g,isDelegating:i}};function L(){const{signer:l,address:o,isConnected:n}=D(),{data:i,isLoading:m,error:u,refetch:s}=V({queryKey:["token-info",o],queryFn:async()=>{if(!o||!n)return{availableBalance:"0",delegatedAmount:"0",totalVotingPower:"0"};try{let c;if(l)c=l;else{const a={}.NEXT_PUBLIC_SEPOLIA_RPC_URL||"https://sepolia.infura.io/v3/";c=new ie(a)}const p=ge("DLoopToken",c),h=await p.balanceOf(o),f=await p.getTotalDelegatedAmount(o),g=h-f,t=await p.getTotalDelegatedToAmount(o);return{availableBalance:I(g),delegatedAmount:I(f),totalVotingPower:I(t)}}catch(c){throw console.error("Error fetching token info:",c),c}},enabled:!!o&&n,staleTime:3e4});return{availableBalance:(i==null?void 0:i.availableBalance)||"0",delegatedAmount:(i==null?void 0:i.delegatedAmount)||"0",totalVotingPower:(i==null?void 0:i.totalVotingPower)||"0",isLoading:m,error:u,refetch:s}}const fe=H({amount:M.number().min(1e-6,"Amount must be at least 0.000001").refine(l=>l>0,{message:"Amount must be greater than 0"})});function De({isOpen:l,onClose:o,recipientAddress:n,recipientName:i,recipientType:m="AI Node",availableBalance:u,node:s,onSuccess:c}){const p=(s==null?void 0:s.address)||n,h=(s==null?void 0:s.name)||i,f=m||"AI Node",{isConnected:g,signer:t}=D(),{toast:a}=q(),{refetch:r}=X(),{refetch:w}=L(),{availableBalance:x}=L(),y=u||parseFloat(x),[E,k]=O.useState(!1),j=R({resolver:Y(fe),defaultValues:{amount:0}}),C=h||$(p||""),P=()=>{j.reset(),o()},ee=b=>{try{return le(b)?{isValid:!0,formattedAddress:ce(b)}:{isValid:!1,error:"The address format is invalid. Please check the address and try again."}}catch(v){return console.warn("Error validating Ethereum address:",b,v),{isValid:!1,error:"Unable to validate the address. Please verify it is correct."}}},te=async b=>{if(!g||!t){a({title:"Not Connected",description:"Please connect your wallet first.",variant:"destructive"});return}if(b.amount>y){a({title:"Insufficient Balance",description:`You have only ${y} DLOOP available to delegate.`,variant:"destructive"});return}k(!0);try{const v=ee(p||"");if(!v.isValid){a({title:"Invalid Address",description:v.error||"The recipient address is invalid.",variant:"destructive"}),k(!1);return}if(!t)throw new Error("No signer available, please reconnect your wallet");await Q.delegateTokens(t,v.formattedAddress||"",b.amount.toString()),r(),w(),a({title:"Delegation Successful",description:`You have successfully delegated ${b.amount} DLOOP to ${C}.`}),c&&c(),P()}catch(v){console.error("Error delegating tokens:",v),a({title:"Delegation Failed",description:v.message||"There was an error delegating your tokens. Please try again.",variant:"destructive"})}finally{k(!1)}},ae=()=>{j.setValue("amount",y)},se={hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.1}}},T={hidden:{y:10,opacity:0},show:{y:0,opacity:1,transition:{type:"spring",stiffness:300,damping:24}}},re=j.watch("amount"),B=parseFloat(re.toString())||0,ne=Math.floor(B*.08);return e.jsx(W,{open:l,onOpenChange:P,children:e.jsx(_,{className:"sm:max-w-[425px]",children:e.jsxs("form",{onSubmit:j.handleSubmit(te),children:[e.jsxs(G,{children:[e.jsx(d.div,{initial:{y:-20,opacity:0},animate:{y:0,opacity:1},transition:{duration:.3},children:e.jsxs(Z,{className:"text-center flex items-center justify-center gap-2",children:[e.jsx("span",{children:"Delegate DLOOP Tokens"}),m==="AI Node"?e.jsx(F,{className:"h-5 w-5 text-purple-500"}):e.jsx(U,{className:"h-5 w-5 text-blue-500"})]})}),e.jsx(d.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.1,duration:.3},children:e.jsxs(K,{className:"text-center",children:["Delegate your DLOOP tokens to ",C," (",m,").",e.jsx("br",{}),"Delegated tokens will increase their voting power while still remaining in your wallet."]})})]}),e.jsxs(d.div,{className:"grid gap-4 py-4",variants:se,initial:"hidden",animate:"show",children:[e.jsxs(d.div,{className:"flex justify-between items-center p-2 rounded-lg bg-muted/50",variants:T,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`h-8 w-8 rounded-full flex items-center justify-center mr-2 ${f==="AI Node"?"bg-purple-100 text-purple-500":"bg-blue-100 text-blue-500"}`,children:f==="AI Node"?e.jsx(F,{className:"h-4 w-4"}):e.jsx(U,{className:"h-4 w-4"})}),e.jsx(A,{children:"Recipient"})]}),e.jsx("span",{className:"text-sm font-medium",children:C})]}),e.jsxs(d.div,{className:"flex justify-between items-center p-2 rounded-lg bg-muted/50",variants:T,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"h-8 w-8 bg-green-100 text-green-500 rounded-full flex items-center justify-center mr-2",children:e.jsx(S,{className:"h-4 w-4"})}),e.jsx(A,{children:"Available Balance"})]}),e.jsxs("span",{className:"text-sm font-medium",children:[y?y.toLocaleString():"0"," DLOOP"]})]}),e.jsxs(d.div,{className:"grid gap-3",variants:T,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(A,{htmlFor:"amount",className:"text-base",children:"Amount to Delegate"}),e.jsx(d.div,{whileHover:{scale:1.05},whileTap:{scale:.95},children:e.jsx(N,{type:"button",variant:"outline",className:"h-10 px-4 text-sm rounded-full",onClick:ae,children:"Max"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"amount",type:"number",step:"0.000001",placeholder:"0.0",className:"transition-all duration-200 focus:ring-2 focus:ring-offset-1 focus:ring-primary h-12 text-lg px-4 rounded-md",...j.register("amount")}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none",children:e.jsx("span",{className:"text-base font-medium",children:"DLOOP"})})]}),j.formState.errors.amount&&e.jsx(d.p,{className:"text-sm text-destructive",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:j.formState.errors.amount.message})]}),B>0&&e.jsx(d.div,{className:"p-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-900",initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},transition:{type:"spring",stiffness:300,damping:24},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(d.div,{animate:{rotate:[0,10,0]},transition:{duration:.5,repeat:1/0,repeatType:"reverse",repeatDelay:2},children:e.jsx(me,{className:"h-4 w-4 text-green-500 mr-2"})}),e.jsx("span",{className:"text-sm",children:"Voting power boost"})]}),e.jsxs("div",{className:"font-medium text-green-600",children:["+",ne.toLocaleString()]})]})})]}),e.jsxs(J,{className:"flex-col sm:flex-row gap-3 mt-2",children:[e.jsx(d.div,{whileHover:{scale:.98},whileTap:{scale:.95},className:"w-full sm:w-auto",children:e.jsx(N,{type:"button",variant:"outline",onClick:P,className:"w-full h-12 text-base",children:"Cancel"})}),e.jsx(d.div,{whileHover:{scale:1.03},whileTap:{scale:.97},className:"w-full sm:w-auto",children:e.jsx(N,{type:"submit",disabled:E||B<=0,className:"relative group overflow-hidden w-full h-12 text-base font-medium",children:E?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs(d.div,{animate:{rotate:360},transition:{duration:1.5,repeat:1/0,ease:"linear"},children:[e.jsx(S,{className:"h-5 w-5"})," "]}),e.jsx("span",{children:"Delegating..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"relative z-10 flex items-center justify-center gap-2",children:["Delegate Tokens",e.jsx(de,{className:"h-5 w-5"})," "]}),e.jsx("span",{className:"absolute inset-0 bg-primary/10 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"})]})})})]})]})})})}const pe=H({amount:M.number().min(1e-6,"Amount must be at least 0.000001").refine(l=>l>0,{message:"Amount must be greater than 0"})});function ke({isOpen:l,onClose:o,delegation:n,onSuccess:i}){const{isConnected:m,signer:u}=D(),{toast:s}=q(),{refetch:c}=X(),{refetch:p}=L(),[h,f]=O.useState(!1),g=R({resolver:Y(pe),defaultValues:{amount:n.amount}}),t=n.toName||$(n.to),a=async x=>{if(!m||!u){s({title:"Not Connected",description:"Please connect your wallet first.",variant:"destructive"});return}if(x.amount>n.amount){s({title:"Invalid Amount",description:`You can only undelegate up to ${n.amount} DLOOP from this delegation.`,variant:"destructive"});return}if(x.amount<=0){s({title:"Invalid Amount",description:"Amount must be greater than 0.",variant:"destructive"});return}f(!0);try{if(!u)throw new Error("No signer available, please reconnect your wallet");await Q.undelegateTokens(u,n.to,x.amount.toString()),c(),p(),s({title:"Undelegation Successful",description:`You have successfully undelegated ${x.amount} DLOOP from ${t}.`}),f(!1),i&&i(),r()}catch(y){console.error("Error undelegating tokens:",y),s({title:"Undelegation Failed",description:y.message||"There was an error undelegating your tokens. Please try again.",variant:"destructive"})}finally{f(!1)}},r=()=>{g.reset(),o()},w=()=>{g.setValue("amount",n.amount)};return e.jsx(W,{open:l,onOpenChange:r,children:e.jsx(_,{className:"sm:max-w-[425px]",children:e.jsxs("form",{onSubmit:g.handleSubmit(a),children:[e.jsxs(G,{children:[e.jsx(Z,{children:"Undelegate DLOOP Tokens"}),e.jsxs(K,{children:["Undelegate your DLOOP tokens from ",t," (",n.toType,"). This will increase your available balance and decrease their voting power."]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(A,{children:"Delegated To"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:t})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(A,{children:"Currently Delegated"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[n.amount," DLOOP"]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(A,{htmlFor:"amount",children:"Amount to Undelegate"}),e.jsx(N,{type:"button",variant:"link",className:"h-auto p-0 text-xs",onClick:w,children:"Max"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(z,{id:"amount",type:"number",step:"0.000001",placeholder:"0.0",...g.register("amount")}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:"DLOOP"})})]}),g.formState.errors.amount&&e.jsx("p",{className:"text-sm text-destructive",children:g.formState.errors.amount.message})]})]}),e.jsxs(J,{children:[e.jsx(N,{type:"button",variant:"outline",onClick:r,className:"mr-2",children:"Cancel"}),e.jsx(N,{type:"submit",disabled:h,className:"bg-primary hover:bg-primary/90",children:h?e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"mr-2",children:"Undelegating"}),e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-t-transparent"})]}):"Undelegate Tokens"})]})]})})})}export{De as D,U,ke as a,L as b,X as u};
