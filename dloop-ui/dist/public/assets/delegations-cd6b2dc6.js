import{A as he,u as Z,E as ue,r as t,D as fe,H as ge,j as e,a0 as o,a2 as Q,s as K,Z as Y,B as w,h as pe,C as je}from"./index-971aa118.js";import{C as b,a as A,b as S,c as D,e as Ne,d as ye}from"./card-66a343e3.js";import{b as ve,U as _,D as we,a as be}from"./undelegate-tokens-modal-3123ce71.js";import{a as W}from"./contracts-444c63f0.js";import{u as De}from"./useAINodes-fc035358.js";import{S as Te}from"./shield-check-5c082b49.js";import{A as Ae}from"./activity-da0d5bb5.js";import{T as Se}from"./trending-up-c108241c.js";import{P as ke}from"./page-header-f6ee8f2a.js";import{P as Ce}from"./PageContainer-a070ff6e.js";import"./index-e4e6a023.js";import"./label-d4220aab.js";import"./tokenDelegationService-8c6507b8.js";import"./api-utils-9109dbff.js";import"./useWallet-793e28b3.js";function Le(){const{provider:r}=he(),{address:l}=Z(),N=ue();return t.useEffect(()=>{if(!r||!l)return;const d=W("DLoopToken",r),h=d.filters.TokensDelegated(l),u=()=>N.invalidateQueries({queryKey:["delegations",l]});return d.on(h,u),()=>d.off(h,u)},[r,N,l]),fe({queryKey:["delegations",l],queryFn:async()=>{if(!r||!l)return[];const d=W("DLoopToken",r),h=d.filters.TokensDelegated(l),u=await d.queryFilter(h,0,"latest");return console.log(`Found ${u.length} delegation events for address ${l}`),(await Promise.all(u.map(async n=>{const g=await r.getBlock(n.blockNumber);return{id:`${n.transactionHash}-${n.logIndex}`,to:n.args.delegatee,toType:"Human",amount:parseFloat(ge(n.args.amount)),date:g.timestamp*1e3}}))).sort((n,g)=>g.date-n.date)},enabled:!!r&&!!l,staleTime:3e4})}function Ie(){const{isConnected:r,address:l}=Z(),[N,d]=t.useState(null),[h,u]=t.useState(null),[k,n]=t.useState(!1),[g,C]=t.useState(!1),[L,M]=t.useState(null),{data:f=[],isLoading:Oe,refetch:G}=Le(),[J,X]=t.useState(0),[I,Pe]=t.useState("All"),[O,Ee]=t.useState("date"),[P,Fe]=t.useState("desc"),[p,U]=t.useState([]),[j,R]=t.useState(!1),y=5,B=t.useMemo(()=>{const a=[...p.filter(c=>I==="All"||c.toType===I)].sort((c,v)=>{let m,x;return O==="date"?(m=c.date,x=v.date):O==="amount"?(m=c.amount,x=v.amount):(m=c.toType,x=v.toType),m<x?P==="asc"?-1:1:m>x?P==="asc"?1:-1:0});return j?a:a.slice(0,y)},[p,I,O,P,j]),{nodes:i,isLoading:$e,error:E}=De(),[V,ee]=t.useState(!1);t.useEffect(()=>{i&&!V&&(console.log(`Delegations view: ${i.length} AI nodes loaded (${i.length>0?"real":"empty"} data)`),ee(!0))},[i,V]);const{availableBalance:se,delegatedAmount:te,totalVotingPower:ae,isLoading:He,refetch:re}=ve(),le=s=>{d(s),n(!0)},q=s=>{console.log("Selected delegation for undelegation:",s),u(s),C(!0)},z=()=>{console.log("Triggering data refresh..."),X(s=>s+1)},ie=s=>{M(L===s?null:s)},F=i||[];t.useEffect(()=>{console.log("Delegations view: AI nodes loaded:",F),E&&console.error("Delegations view: AI nodes error:",E)},[F,E]);const ne=se||0,oe=te||0,de=ae||0,$=t.useRef(!1),T=t.useRef(0);t.useEffect(()=>{if($.current||T.current>5)return;(async()=>{if(r&&l){$.current=!0,T.current++,console.log(`Refreshing delegations data... (attempt ${T.current})`);try{await G(),console.log("Delegations data refreshed successfully"),await re(),console.log("Token info refreshed successfully")}catch(a){console.error("Error refreshing data:",a)}finally{$.current=!1}}})()},[r,l,J]),t.useEffect(()=>{T.current=0},[l]);const ce={hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.1}}},H={hidden:{y:20,opacity:0},show:{y:0,opacity:1,transition:{type:"spring",stiffness:300,damping:24}}},me=t.useMemo(()=>{var s;return((s=i==null?void 0:i.map(a=>a.address))==null?void 0:s.join(","))||""},[i]),xe=t.useMemo(()=>{var s;return((s=f==null?void 0:f.map(a=>a.id))==null?void 0:s.join(","))||""},[f]);return t.useEffect(()=>{if(!f.length){U([]);return}let s;i&&i.length>0?(s=f.map(a=>{const c=i.find(v=>{var m,x;return((m=v.address)==null?void 0:m.toLowerCase())===((x=a.to)==null?void 0:x.toLowerCase())});return c?{...a,toName:c.name,toType:"AI Node"}:a}),console.log(`Updated delegations with AI node information: ${s.length}`)):s=[...f],U(s)},[me,xe]),e.jsxs("div",{className:"space-y-6 max-w-[100vw] px-4 md:px-6",children:[e.jsxs(o.div,{className:"grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3",variants:ce,initial:"hidden",animate:"show",children:[e.jsx(o.div,{variants:H,whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs(b,{className:"overflow-hidden border-t-4 border-t-blue-500 transition-all duration-200 hover:shadow-lg",children:[e.jsx(A,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(S,{className:"text-sm font-medium",children:"Available DLOOP"}),e.jsx(Te,{className:"h-4 w-4 text-blue-500"})]})}),e.jsxs(D,{children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold",children:ne.toLocaleString(void 0,{maximumFractionDigits:2})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Available for delegation"})]})]})}),e.jsx(o.div,{variants:H,whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs(b,{className:"overflow-hidden border-t-4 border-t-purple-500 transition-all duration-200 hover:shadow-lg",children:[e.jsx(A,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(S,{className:"text-sm font-medium",children:"Delegated DLOOP"}),e.jsx(Ae,{className:"h-4 w-4 text-purple-500"})]})}),e.jsxs(D,{children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold",children:oe.toLocaleString(void 0,{maximumFractionDigits:2})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Currently delegated to others"})]})]})}),e.jsx(o.div,{variants:H,whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs(b,{className:"overflow-hidden border-t-4 border-t-green-500 transition-all duration-200 hover:shadow-lg",children:[e.jsx(A,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(S,{className:"text-sm font-medium",children:"Total Voting Power"}),e.jsx(Se,{className:"h-4 w-4 text-green-500"})]})}),e.jsxs(D,{children:[e.jsx("div",{className:"text-xl md:text-2xl font-bold",children:de.toLocaleString(void 0,{maximumFractionDigits:2})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your influence in the DAO"})]})]})})]}),e.jsxs(o.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"overflow-x-auto",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"My Delegations"}),e.jsxs("div",{className:"md:hidden",children:[B.map(s=>e.jsx(o.div,{className:"mb-4",whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsx(b,{children:e.jsxs(D,{className:"py-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:`h-8 w-8 rounded-full flex items-center justify-center ${s.toType==="AI Node"?"bg-primary/10 text-primary":"bg-blue-100 text-blue-800"}`,children:s.toType==="AI Node"?e.jsx(Q,{className:"h-4 w-4"}):e.jsx(_,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.toName||K(s.to)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.toType})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsx("div",{className:"text-muted-foreground",children:"Amount:"}),e.jsxs("div",{className:"text-right font-medium",children:[s.amount.toLocaleString()," DLOOP"]}),e.jsx("div",{className:"text-muted-foreground",children:"Date:"}),e.jsx("div",{className:"text-right",children:Y(s.date)})]}),e.jsx(w,{variant:"outline",size:"sm",className:"w-full mt-4",disabled:!r,onClick:()=>q(s),children:"Undelegate"})]})})},s.id)),p.length>y&&e.jsx(o.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},className:"mt-4 flex justify-center",children:e.jsx(w,{variant:"outline",size:"sm",onClick:()=>R(!j),className:"w-full sm:w-auto",children:j?"Show Less":`Show More (${p.length-y} more)`})})]}),e.jsx("div",{className:"hidden md:block",children:e.jsxs("div",{className:"rounded-lg border overflow-hidden",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Delegatee"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Amount"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Type"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium",children:"Actions"})]})}),e.jsx("tbody",{children:B.map(s=>e.jsxs(o.tr,{className:"hover:bg-muted/50 transition-colors",whileHover:{backgroundColor:"rgba(0,0,0,0.02)"},children:[e.jsx("td",{className:"px-4 py-2 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`h-8 w-8 rounded-full flex items-center justify-center mr-3 ${s.toType==="AI Node"?"bg-primary/10 text-primary":"bg-blue-100 text-blue-800"}`,children:s.toType==="AI Node"?e.jsx(Q,{className:"h-4 w-4"}):e.jsx(_,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.toName||K(s.to)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.toType})]})]})}),e.jsx("td",{className:"px-4 py-2 border-t border-gray-200",children:(()=>{const a=new Date(s.date);return isNaN(a.getTime())?"â€”":Y(s.date)})()}),e.jsxs("td",{className:"px-4 py-2 border-t border-gray-200",children:[s.amount.toLocaleString()," DLOOP"]}),e.jsx("td",{className:"px-4 py-2 border-t border-gray-200",children:s.toType}),e.jsx("td",{className:"px-4 py-2 border-t border-gray-200",children:e.jsx(w,{variant:"outline",size:"sm",disabled:!r,onClick:()=>q(s),children:"Undelegate"})})]},s.id))})]}),p.length>y&&e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(w,{variant:"outline",size:"sm",onClick:()=>R(!j),className:"w-auto",children:j?"Show Less":`Show More (${p.length-y} more)`})})]})})]}),e.jsxs(o.div,{id:"ai-nodes-section",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"overflow-x-auto",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Available AI Nodes"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:F.map((s,a)=>e.jsx(o.div,{whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs(b,{className:"overflow-hidden h-full flex flex-col",children:[e.jsxs(A,{className:"pb-2",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(S,{className:"text-base font-medium",children:s.name}),s.soulboundTokenId&&e.jsxs(pe,{variant:"secondary",className:"text-xs bg-purple-100 text-purple-800",children:["NFT #",s.soulboundTokenId]})]})}),e.jsx(Ne,{children:s.strategy})]}),e.jsxs(D,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Accuracy"}),e.jsxs("span",{className:"font-medium",children:[s.accuracy,"%"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Performance"}),e.jsxs("span",{className:"font-medium",children:["+",s.performance,"%"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Delegated"}),e.jsxs("span",{className:"font-medium",children:[s.delegatedAmount.toLocaleString()," DLOOP"]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("button",{onClick:()=>ie(a),className:"flex items-center text-sm text-primary w-full justify-between",children:[e.jsx("span",{children:"Node Details"}),e.jsx(je,{className:`h-4 w-4 transition-transform ${L===a?"rotate-180":""}`})]}),L===a&&e.jsxs(o.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"mt-3 text-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Address:"}),e.jsx("div",{className:"font-mono text-xs mt-1",children:s.address})]}),s.tokenData&&s.tokenData.metadata&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Description:"}),e.jsx("div",{className:"mt-1",children:s.tokenData.metadata.description||"No description available"})]})]})]})]}),e.jsx(ye,{className:"mt-auto",children:e.jsx(w,{className:"w-full",disabled:!r,onClick:()=>le(s),children:"Delegate Tokens"})})]})},s.id))})]}),k&&N&&e.jsx(we,{node:N,isOpen:k,onClose:()=>n(!1),onSuccess:()=>{n(!1),z()}}),g&&h&&e.jsx(be,{delegation:h,isOpen:g,onClose:()=>C(!1),onSuccess:()=>{C(!1),z()}})]})}function Xe(){return e.jsx(Ce,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(ke,{title:"DLOOP Delegations",description:"Delegate your DLOOP tokens to AI nodes and trusted community members to increase their voting power while retaining ownership."}),e.jsx(Ie,{})]})})}export{Xe as default};
